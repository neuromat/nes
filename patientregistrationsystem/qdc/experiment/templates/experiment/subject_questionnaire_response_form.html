{% extends "quiz/template.html" %}
{% block activeAdvancedExperiment %}class="active"{% endblock %}

{% block header %}

    <script type="text/javascript">

    function windowOpen() {
        var childWindow2 = window.open("{{ URL }}",'_blank');
{#        childWindow2.location.reload(true);#}
    };

    </script>

{% endblock %}

{% block form %}
    <div class="row">
    <form id="subject_form" method="post">
    {% csrf_token %}
{% endblock %}

{% block content %}

    <div class="tab-pane fade in active" id="subjectBreadCrumb">

        <div class="col-md-1">
        </div>

        <div class="col-md-10">

            <ol class="breadcrumb">
                <li>Home</li>
                <li><a href="/experiment/list">Experimentos</a></li>
                <li><a href="/experiment/edit/{{ questionnaire_configuration.experiment.id }}/">{{ questionnaire_configuration.experiment.title }} </a></li>
                <li><a href="/experiment/{{ questionnaire_configuration.experiment.id }}/subjects/">Participantes</a></li>
                <li>
                    <a href="/experiment/{{ questionnaire_configuration.experiment.id }}/subjects/{{ subject.id }}/questionnaire">{{ subject.patient.name_txt }}</a>
                </li>
                <li class="active">
                    {{ survey_title }}
                </li>
                {% if creating %}
                    <li class="active">Novo preenchimento</li>
                {% else %}
                    <li class="active"></li>
                {% endif %}
            </ol>

        </div>

        <div class="col-md-1">
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}

            {% if message.tags == "success" %}
                <script>showSuccessMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "warning" %}
                <script>showWarningMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "error" %}
                <script>showErrorMessage('{{ message }}')</script>
            {% endif %}

            {% if message.tags == "info" %}
                <script>showInfoMessage('{{ message }}')</script>
            {% endif %}

        {% endfor %}
    {% endif %}

    {% if FAIL == True %}
        <script>
{#            popup('{{ URL }}');#}
{#            child = window.open("{{ URL }}");#}
{#            setTimeout(function () {#}
{#                alert("agora");#}
{#                child.location.reload(true);#}
{#            }, 3000);#}
{#            setTimeout(function () {#}
{#                window.location.href = '/experiment/{{ questionnaire_configuration.experiment.id }}/subjects/{{ subject.id }}/questionnaire/'#}
{#            }, 3000);#}
        </script>
    {% endif %}

    {% if FAIL == True %}
        <a href="javascript:windowOpen();">Nova janela</a>
        <a href="{{ URL }}">Nesta janela</a>

        <input type='button' id='btnOpen' value='Open Child'>
        <input type='button' id='btnClose' value='Close Child'>
        <input type='button' id='btnRefresh' value='Refresh Child'>

    {% endif %}

    <div class="tab-pane fade in active" id="menuUserTab">
    <div class="col-md-10">
        <div class="container span6 offset3 well ">
            <div class="col-md-10">
                <div class="row">
                    <div class="col-xs-12 col-sm-12">
                        <div class="form-group">
                            <label>Questionário</label>

                            <div class="input-group input-group-sm">
                                <span class="input-group-addon"><span
                                        class="glyphicon glyphicon-folder-open"></span></span>
                                <input class="form-control" id="id_survey_title" name="survey_title"
                                       value="{{ survey_title }}"
                                       type="text" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <div class="row">
                    <div class="col-xs-3 col-sm-6">
                        <div class="form-group">
                            <label>Administrador</label>

                            <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><span
                                            class="glyphicon glyphicon-user"></span></span>
                                <input class="form-control" id="id_survey_admin" name="survey_admin"
                                       value="{{ survey_admin }}" type="text" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-3 col-sm-6">
                        <div class="form-group">
                            <label>Responsável</label>

                            <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><span
                                            class="glyphicon glyphicon-user"></span></span>
                                <input class="form-control" id="id_responsible" name="responsible"
                                       value="{{ questionnaire_responsible }}" type="text" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <div class="row">
                    <div class="col-xs-3 col-sm-6">
                        <div class="form-group">
                            <label>Participante</label>

                            <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><span
                                            class="glyphicon glyphicon-user"></span></span>
                                <input class="form-control" id="id_subject" name="subject"
                                       value="{{ subject.patient.name_txt }}" type="text" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-3 col-sm-6">

                        <div class="form-group {% if questionnaire_response_form.errors.date %}has-error{% endif %}">
                            <label for="date_birth_txt" class="control-label">Data de preenchimento<b
                                    style="color: red;">*</b></label>

                            <div class="input-group input-group-sm">
                                <span class="input-group-addon"> <span class="glyphicon glyphicon-th"></span></span>
                                {% if completed or not creating %}
                                    <input class="form-control" id="fill_date"
                                       value="{{ questionnaire_response_form.date.value|date:"d/m/Y" }}" type="text" disabled>
                                {% else %}
                                    {{ questionnaire_response_form.date }}
                                {% endif %}
                            </div>
                            <div class="help-block with-errors">
                                {% if questionnaire_response_form.date.errors %}
                                    <span>
                                        {% for error in questionnaire_response_form.date.errors %}{{ error }}{% endfor %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <div class="btn-toolbar">
            <div class="btn-group pull-left">
                {% if not creating and perms.experiment.delete_questionnaireresponse %}
                    <button type="button" class="btn btn-danger" onclick="$('#modalRemove').modal('show')">Excluir</button>
                {% endif %}
            </div>
            <div class="btn-group pull-right">
                {% if not completed %}
                    <button type="submit" name="action" value="save" class="btn btn-primary">{% if creating %}Novo preenchimento{% else %}Continuar preenchimento{% endif %}</button>
                {% endif %}
            </div>
            <div class="btn-group pull-right">
                <a href="/experiment/{{ questionnaire_configuration.experiment.id }}/subjects/{{ subject.id }}/questionnaire" class="btn"
                   style="background-color: #f5f5f5">Voltar</a>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalRemove" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    Tem certeza que deseja excluir o preenchimento deste questionário?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" value="remove" name="action">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        (function() {
          var childWindow;

          document.getElementById('btnOpen').onclick = openChildWindow;
          document.getElementById('btnClose').onclick = closeChildWindow;
          document.getElementById('btnRefresh').onclick = refreshChildWindow;

          function openChildWindow() {
            if (childWindow) {
              alert("We already have one open.");
            }
            else {
        {#      childWindow = window.open('http://jsbin.com/awiri4');#}
              childWindow = window.open('{{ URL }}');
        {#      childWindow.close();#}
        {#      childWindow = window.open('{{ URL }}');#}
            }
          }

          function closeChildWindow() {
            if (!childWindow) {
              alert("There is no child window open.");
            }
            else {
              childWindow.close();
              childWindow = undefined;
            }
          }

          function refreshChildWindow() {
            if (!childWindow) {
              alert("There is no child window open.");
            }
            else {
              childWindow.location.reload();
            }
          }
        })();

    </script>

{% endblock %}

{% block end_form %}
    </form>
    </div>
{% endblock %}